# CountryCurrencyApi

A small .NET 8 Web API that fetches country data and USD exchange rates from public APIs, stores/upserts countries into a MySQL database, computes a simple estimated GDP, and generates a PNG summary image. Exposes endpoints to refresh data, query countries, retrieve status and download the summary image.

---

## Contents

- Features
- Requirements
- Quick start (local)
- Configuration
- Database / Migrations
- API endpoints (examples)
- Data model
- Implementation notes
- Troubleshooting
- Security & production notes
- License

---

## Features

- Fetches country metadata from https://restcountries.com and USD exchange rates from https://open.er-api.com.
- Upserts countries by name (unique index).
- Computes `EstimatedGdp` = population × random(1000–2000) ÷ exchange_rate (per spec) with handling when currencies or rates are missing.
- Persists countries in MySQL via Entity Framework Core.
- Generates `cache/summary.png` summarizing total countries and top 5 by estimated GDP (SkiaSharp).
- Exposes Swagger UI for manual exploration.

---

## Requirements

- .NET 8 SDK
- MySQL-compatible database (connection string shown in appsettings.json)
- Visual Studio 2022 or CLI
- NuGet packages used (indicative):
  - Microsoft.EntityFrameworkCore
  - Pomelo.EntityFrameworkCore.MySql (or other MySQL provider)
  - SkiaSharp
  - Swashbuckle.AspNetCore (Swagger)

---

## Quick start (local)

1. Open the solution in Visual Studio 2022 or use the CLI.
2. Configure the DB connection string (see "Configuration" below).
3. Ensure migrations are available (this repo includes an initial migration).
4. Run the app:
   - Visual Studio: set the startup project and press Run (F5) or use __Solution Explorer__ and __Properties > Debug__ as needed.
   - CLI:
     ```bash
     dotnet run
     ```
   The app will apply EF migrations at startup (Program.cs calls `db.Database.Migrate()`).

4. Open Swagger UI:
   - http://localhost:{PORT}/swagger

---

## Configuration

Primary place: `appsettings.json` (example provided). For production prefer environment variables.

- appsettings.json connection example: "ConnectionStrings": { "DefaultConnection": "server=...;port=...;database=...;user=...;password=...;" }
- Environment variable override:
- `CONNECTION_STRING` — full connection string
- Or use ASP.NET configuration convention: `ConnectionStrings__DefaultConnection`

Tips:
- To run migrations from CLI:
- Add/update migrations: `dotnet ef migrations add <Name>`
- Apply migrations: __dotnet ef database update__
- From Visual Studio Package Manager Console:
- Apply migrations: __Update-Database__

---

## Database / Migrations

- Single entity: `Country`
- Migration included: `Migrations/20251026025335_InitialCreate.cs`
- Table: `Countries` with unique index on `Name`.

If you change the model: dotnet ef migrations add SomeName dotnet ef database update

---

## API Endpoints

Base route: `/`

Swagger UI exposes all endpoints (default route for controllers).

- POST /countries/refresh
  - Triggers a refresh: fetch external APIs, upsert countries, write `cache/summary.png`.
  - Responses:
    - 200 OK - { message, total, last_refreshed_at }
    - 503 Service Unavailable - external API failure
    - 500 Internal Server Error - other failures
  - Example:
    ```bash
    curl -X POST http://localhost:5000/countries/refresh
    ```

- GET /countries
  - List countries. Query parameters:
    - `region` (filter by region, case-insensitive)
    - `currency` (filter by currency code, case-insensitive)
    - `sort` = `gdp_desc` | `gdp_asc`
  - Example:
    ```bash
    curl "http://localhost:5000/countries?region=Africa&sort=gdp_desc"
    ```

- GET /countries/{name}
  - Get a single country by name (case-insensitive).
  - Example:
    ```bash
    curl "http://localhost:5000/countries/Nigeria"
    ```

- DELETE /countries/{name}
  - Delete by name.
  - Example:
    ```bash
    curl -X DELETE "http://localhost:5000/countries/SmallState"
    ```

- GET /countries/image
  - Returns `cache/summary.png` generated by the refresh flow.
  - Returns 404 if image missing.

- GET /status
  - Returns:
    - `total_countries`
    - `last_refreshed_at`
  - Example:
    ```bash
    curl http://localhost:5000/status
    ```

---

## Data model (Country)

Fields (see `Models/Country.cs`):
- Id (int)
- Name (string) — unique, required
- Capital (string?)
- Region (string?)
- Population (long)
- CurrencyCode (string?) — ISO code (e.g., USD)
- ExchangeRate (double?) — relative to USD
- EstimatedGdp (double?) — computed
- FlagUrl (string?)
- LastRefreshedAt (DateTime)

Notes:
- If a country has no currency info: CurrencyCode and ExchangeRate are null and EstimatedGdp is set to 0 (per service logic).
- If exchange rate missing for the detected currency: ExchangeRate and EstimatedGdp remain null.

---

## Implementation notes

- External API access:
  - RestCountries: `https://restcountries.com/v2/all?fields=name,capital,region,population,flag,currencies`
  - Exchange rates: `https://open.er-api.com/v6/latest/USD`
- Upsert logic: match by `Name` (case-insensitive).
- Transactions: refresh uses a DB transaction; if save fails the transaction rolls back and no image is written.
- Image generation: uses SkiaSharp to produce `cache/summary.png` (generated after DB commit).
- Startup behavior: migrations applied automatically on start (see Program.cs).

---

## Troubleshooting

- "Database connection string not provided" at startup:
  - Set `ConnectionStrings__DefaultConnection` in environment or provide `CONNECTION_STRING`.
- MySQL provider errors:
  - Ensure you have a compatible EF Core MySQL provider (Pomelo) and correct server version.
- External API failures:
  - `POST /countries/refresh` will return 503 if external fetch fails. Check logs for details.
- Summary image not found:
  - Run a successful `POST /countries/refresh` to generate `cache/summary.png` or ensure the `cache` folder is writable by the app.

---

## Security & production notes

- Secrets: do not check DB credentials into source control. Use secret stores or environment variables.
- Resilience: external calls are performed with a short timeout (30s) and errors result in 503 from the refresh endpoint.
- Consider adding:
  - Authentication/authorization on endpoints.
  - Caching, rate-limiting for the refresh endpoint.
  - Background scheduled refresh (e.g., hosted service) rather than manual POST.
  - Health checks and logging/monitoring.

---

## Contributing / Development

- Build with .NET 8 SDK.
- Keep migrations in sync: add a migration after model changes and commit it.
- Use the existing initial migration as a reference in `Migrations/`.

---

## Contact / Attribution

This repository integrates public APIs:
- restcountries.com
- open.er-api.com
